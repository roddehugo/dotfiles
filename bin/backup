#!/bin/bash

# Disc backup script
# Requires rsync 3

# Ask for the administrator password upfront
# sudo -v

# IMPORTANT: Make sure you update the `DST` variable to match the name of the
# destination backup drive

source ./shell/bash.d/colors
source ./shell/bash.d/utils
source ./shell/bash.d/functions/pip

# Ask before potentially overwriting files
seek_confirmation "Warning: This step may overwrite your existing backup files."

e_header "brew"

# Bakcup list of applications installed
ls -l /Applications/ | grep .app | sed 's/\.app//g' | sed 's/ \( \)*/ /g' | cut -d' ' -f9- | grep -v Caskroom > "${DOTFILES_DIRECTORY}"/installed/Applicationsfile
find /Applications -path '*Contents/_MASReceipt/receipt' -maxdepth 4 -print |\sed 's#.app/Contents/_MASReceipt/receipt#.app#g; s#/Applications/##' > "${DOTFILES_DIRECTORY}"/installed/AppStorefile
brew tap  | awk '{print $1}' > "${DOTFILES_DIRECTORY}"/installed/Tapfile
brew list  | awk '{print $1}' > "${DOTFILES_DIRECTORY}"/installed/Brewfile
brew cask list  | awk '{print $1}' > "${DOTFILES_DIRECTORY}"/installed/Caskfile

e_header "gem"

gem list | awk '{print $1}' > "${DOTFILES_DIRECTORY}"/installed/Gemfile

# Backup list of Npm packages
e_header "npm"

# Backup list of Npm packages
ls $(npm prefix --global)/lib/node_modules > "${DOTFILES_DIRECTORY}"/installed/Npmfile

e_header "pip"

# Backup list of pip 2.7 and pip 3 packages
gpip list | awk '{print $1}' > "${DOTFILES_DIRECTORY}"/installed/Pipfile
gpip3 list | awk '{print $1}'> "${DOTFILES_DIRECTORY}"/installed/Pip3file

# Prepare variables to be used by rsync
SRC=${HOME}/
DST=/Volumes/Macintosh\ CR/Backups/
EXCLUDE=${DOTFILES_DIRECTORY}/bin/.backupignore

if [[ ! -r "${SRC}" ]]; then
    e_error "Source ${SRC} not readable - Cannot start the sync process"
    exit
fi

if [[ ! -w "${DST}" ]]; then
    e_error "Destination ${DST} not writeable - Cannot start the sync process"
    exit
fi

e_header "rsync"

# --acls                   update the destination ACLs to be the same as the source ACLs
# --archive                turn on archive mode (recursive copy + retain attributes)
# --delete                 delete any files that have been deleted locally
# --delete-excluded        delete any files (on DST) that are part of the list of excluded files
# --exclude-from           reference a list of files to exclude
# --hard-links             preserve hard-links
# --one-file-system        don't cross device boundaries (ignore mounted volumes)
# --sparse                 handle sparse files efficiently
# --verbose                increase verbosity
# --xattrs                 update the remote extended attributes to be the same as the local ones

rsync  --acls \
       --archive \
       --delete \
       --delete-excluded \
       --exclude-from="$EXCLUDE" \
       --hard-links \
       --one-file-system \
       --sparse \
       --verbose \
       --xattrs \
       --quiet \
       "${SRC}" "${DST}"

exit 0
